# Pit Stop Indicator Lamp

事務所にある男性用トイレの交通整理のために、トイレの利用状態を確認する
簡単なアプリケーションを用意したいのです。

## はじめに

### どうしてこんなことになった

会社には10名ちょっとの男性がいますが、トイレは個室が1個しかありません。
社内の人数が多い時にはしょっちゅうコリジョンが発生しますが、トイレの
利用状況の確認は作業部屋を出てトイレが見えるところまで行く必要があり、
自席とトイレの間をなんども往復する現象が発生していました。

自席に居てもトイレが利用中か確認できれば、ウロウロしなくてすむはずです。

### 過去の事例を調べた

トイレの利用状況を把握するツール、過去の事例で有名なものでは、チーム
ラボの「ヘブンズ・ドアー」があります。
この例では個室が利用可能か、扉の開け閉めをセンサーで確認しています。

<dl>
<dt>【紹介記事】</dt>
<dd>
おばかアプリ作成のための超まじめな勉強会レポート (1/3) <br/>
<a href="http://www.atmarkit.co.jp/ait/articles/1005/21/news102.html">
http://www.atmarkit.co.jp/ait/articles/1005/21/news102.html</a>
</dd>
</dl>

今調べたらこの仕組みは既に販売されていて、今回わしらが使った費用より
安いんです…。

[ヘブンズ・ドアー](http://heavens-door.info)

また、トイレは電源が取れない可能性が高いです。また、作業部屋の外の
公共スペースに設置されており有線構造にする事は難しいため、乾電池でも
動く省電力の無線センサーを利用することにしました。

これはニコニコ技術部のミクミンPさんの例を参考にしています。

<dl>
<dt>【紹介記事】</dt>
<dd>
超低消費電力無線センサでミクさんと生活してみた <br/>
<a href="http://www.slideshare.net/ksasao/ss-38527969">
http://www.slideshare.net/ksasao/ss-38527969</a>
<br/><br/>
TWE-Lite DIP で玄関とお風呂場の無線ドア開閉センサ作った。<br/>
<a href="https://twitter.com/ksasao/status/515844971136425985">
https://twitter.com/ksasao/status/515844971136425985</a>
</dd>
</dl>

### 方針を決めよう

チームラボの例とはトイレの構造がちょっと違うので、彼らが採用していたタッ
チセンサー様のものは利用できません。
ではどうするとよさそうか、ヒアリングしました。
その結果、通常、男性陣がトイレの利用可否を確認するのは「トイレ入口上部の
隙間から漏れる明かり」だったので、その明かりが室内でも確認できれば
いいんじゃないかということになりました。

無線モジュールはミクミンPという先達の居るTWE-Liteを利用する事にしました。
サイト内のHowToも充実しているので、困ってもなんとかなりそう、という事も
理由です。

超小型ZigBee無線モジュール　ワイヤレスエンジン　TWE-Lite（トワイライト）
http://tocos-wireless.com/jp/products/TWE-001Lite.html


## 測光センサーでトイレの利用状態を把握する

### 何をどうするの？

とるものもとりあえず設計です。
トイレに置いた無線モジュール（子機その1）で測光結果を取得し、親機が定
期的にクロールしてデータを取得、PCでデータを加工して居室で確認できる
データに変換したいと思います。
居室では無線モジュール（子機その2）が加工データを受け取り、トイレ点灯
中はLEDが点灯する仕組みを用意します。

TWE-Liteは色々なモデルがありますが、親機、子機は以下の機材を
利用します。

<dl>
<dt>無線LANセンサ（子機その1）（子機その2）</dt>
<dd>
TWE-Lite DIP<br/>
<a href="http://tocos-wireless.com/jp/products/TWE-Lite-DIP/index.html">
http://tocos-wireless.com/jp/products/TWE-Lite-DIP/index.html</a>
</dd>
<dt>無線LANセンサ（親機）</dt>
<dd>
ToCoStick（トコスティック）<br/>
<a href="http://tocos-wireless.com/jp/products/TWE-Lite-USB/">
http://tocos-wireless.com/jp/products/TWE-Lite-USB/</a>
</dd>
</dl>

測光センサは秋月電子通商で2個100円（2014年12月現在）で販売しているNJL7502を
利用します。
点灯用のLEDはマルツで購入した赤色LEDを利用します。

測光センサ
照度センサ[NJL7502L]
LED
フラットLED(5mm 赤・2.2V・20mA・500mcd(max)) Linkman LFTLED-R501
JANコード/ISBNコード：4547634224113



## 作ってみる！

### 測光用モジュールを組み立てる

測光用にTWE-Lite-DIPを設定します。

子機は以下の図の「可変抵抗」を測光センサで置き換えます。抵抗は1000Ωの
ものを利用しました。
http://tocos-wireless.com/jp/products/TWE-Lite-DIP/TWE-Lite-DIPS1-2.jpg

測光センサは光の強さをアナログデータとして取得します。
親機はPCに接続するとシリアル接続で通信可能です。
子機のハンドル方法、取得可能なデータと形式は以下で確認可能です。

http://tocos-wireless.com/jp/products/TWE-Lite-USB/monitor.html

子機から送られたセンサデータはアナログ入力（AI）の値で取得可能です。
また、この機材だけは乾電池必須なので、稼働タイミングを間欠1秒に設定しま
した。

### LED点灯用モジュールを設定する

(1)LED点灯用にTWE-Lite-DIPを設定します。



(2) blink(1) mk2にデータを送ってみます。



### 測光データ取得してLED点滅用データに加工する

測光用モジュールから取得した光量情報（アナログデータ）を切り出して点灯中かどうか判断し、
LED点滅用のTWE-Lite-DIPに点滅を指示する情報（デジタルデータ）を作成します。

## 設置する

基盤を裸のまま置き去りにするのは発火の心配があったり錆びたり壊れたり、色々と問題が多いので
とりあえずカバーを用意します。
LEDも単独の点灯は見過ごされがちなのでカバーをつけて発行領域を広くします。




## 謝辞

ひとりでは何一つまともにできないのですが、色々な人たちが作業をしたり
助言をしてくれたおかげで何かができました。
このアイディアに直結している皆様、ありがとうございます。

* コーディングと設置をあっという間に全部やってしまった、正直この仕組みの作者である@wannabe53
* このアイディアの元になった「トイレが混んでて困る！」とつぶやいた@ryosuke927
* 自力で何とかチェックシステムを作る前例を提供してくれたチームラボの方々
* TWE-Liteの楽しい使い方を日々提供してくれているミクミンPさま@ksasao
* LED点灯用モジュールを作るときのアイディア出しをしてくれた@gotoyuzo

ここに挙げた人たちだけじゃなく、こんな事をしていても生暖かく見守ってくれるNaClの
事務所の人たち、また、10年以上も居心地の良い環境を提供してくれているビルの
オーナー様に感謝しています。



